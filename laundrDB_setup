-- 1. DATABASE CREATION
DROP DATABASE IF EXISTS laundr;
CREATE DATABASE laundr;
USE laundr;

-- 2. TABLE CREATION
-- Customer Info
CREATE TABLE customer (
    custID INT PRIMARY KEY AUTO_INCREMENT,
    custUsername VARCHAR(50) UNIQUE NOT NULL,
    custPassword VARCHAR(255) NOT NULL,
    custPhone VARCHAR(20) UNIQUE,
    custAddress VARCHAR(150),
    custEmail VARCHAR(100) UNIQUE,
    walletBalance DECIMAL(10, 2) DEFAULT 0.00 -- <-- NEW COLUMN
) AUTO_INCREMENT = 1001; -- Starts customer IDs at 1001

-- Admin
CREATE TABLE admin (
    adminID INT PRIMARY KEY AUTO_INCREMENT,
    adminUsername TEXT NOT NULL,
    adminPassword TEXT NOT NULL
);

-- Laundromats (with new UI columns)
CREATE TABLE laundromat (
    laundromatID INT PRIMARY KEY AUTO_INCREMENT,
    laundromatName VARCHAR(100) NOT NULL,
    laundromatAddress VARCHAR(150) NOT NULL,
    rating DECIMAL(2,1) DEFAULT 0.0,
    distanceFromUser VARCHAR(20) DEFAULT 'N/A',
    estimatedTime VARCHAR(50) DEFAULT 'N/A',
    highlights VARCHAR(255) DEFAULT 'Standard Wash & Fold',
    imagePath VARCHAR(255) DEFAULT 'Pictures/default.png'
);

-- Laundromat Services
CREATE TABLE service (
    serviceID INT PRIMARY KEY AUTO_INCREMENT,
    laundromatID INT,
    serviceName VARCHAR(100), -- ex Wash & Fold, Iron, etc
    description TEXT,
    price DECIMAL(10,2),
    estimatedTime INT, -- in hours
    FOREIGN KEY (laundromatID) REFERENCES laundromat(laundromatID)
);

-- Laundry Orders (with full ENUM status list)
CREATE TABLE orders (
    orderID INT PRIMARY KEY AUTO_INCREMENT,
    custID INT,
    laundromatID INT,
    orderDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    pickupAddress VARCHAR(150),
    deliveryAddress VARCHAR(150),
    orderStatus ENUM(
        'pending',
        'accepted',
        'in_progress',
        'ready_for_delivery',
        'out_for_delivery',
        'completed',
        'cancelled'
    ) DEFAULT 'pending',
    totalAmount DECIMAL(10,2),
    FOREIGN KEY (custID) REFERENCES customer(custID),
    FOREIGN KEY (laundromatID) REFERENCES laundromat(laundromatID)
) AUTO_INCREMENT = 2001; -- Starts order IDs at 2001

-- Order Details (links orders to services)
CREATE TABLE orderDetails (
    orderDetailsID INT PRIMARY KEY AUTO_INCREMENT,
    orderID INT,
    serviceID INT,
    quantity INT DEFAULT 1,
    subtotal DECIMAL(10,2),
    FOREIGN KEY (orderID) REFERENCES orders(orderID),
    FOREIGN KEY (serviceID) REFERENCES service(serviceID)
);

-- Payments
CREATE TABLE payment (
    paymentID INT PRIMARY KEY AUTO_INCREMENT,
    orderID INT,
    paymentDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    paymentMethod ENUM('cash','card','gcash','maya') DEFAULT 'cash',
    paymentStatus ENUM('unpaid','paid','refunded') DEFAULT 'unpaid',
    amount DECIMAL(10,2),
    FOREIGN KEY (orderID) REFERENCES orders(orderID)
);

-- Customer Reviews
CREATE TABLE review (
    reviewID INT PRIMARY KEY AUTO_INCREMENT,
    orderID INT,
    laundromatID INT,
    custID INT,
    rating INT CHECK (rating BETWEEN 1 AND 5),
    comment TEXT,
    createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (orderID) REFERENCES orders(orderID),
    FOREIGN KEY (laundromatID) REFERENCES laundromat(laundromatID),
    FOREIGN KEY (custID) REFERENCES customer(custID)
);

-- Notifications (for Observer pattern)
CREATE TABLE notification (
    notificationID INT PRIMARY KEY AUTO_INCREMENT,
    custID INT NOT NULL,
    message TEXT NOT NULL,
    isRead BOOLEAN DEFAULT FALSE,
    createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (custID) REFERENCES customer(custID)
);

-- ------------------------------------------------------------------
-- 3. DATA INSERTION
-- ------------------------------------------------------------------

-- 1. INSERT ADMIN
INSERT INTO admin (adminUsername, adminPassword)
VALUES ('laundradmin', 'laundradmin');

-- 2. INSERT LAUNDROMATS (ONLY THE 5)
INSERT INTO laundromat
(laundromatName, laundromatAddress, rating, imagePath, distanceFromUser, estimatedTime, highlights)
VALUES
('WashEat Laundry', '100 Wash St, Zamboanga City', 0, 'Pictures/washeat.png', '1.0 km', '1 Day', 'Open 24 Hours,Hypoallergenic Options,Stain Pre-Treat,Sanitized Machines,Bedding & Large Items,Competitive Pricing'),
('La Vahh Laundromat', '200 La Vahh Ave, Cebu City', 0, 'Pictures/lavahh.png', '2.1 km', '1-2 Days', 'Extended Hours,Delicates Care,Hypoallergenic Options,Hand-Finished Option,Rewash Guarantee'),
('Allklean Laundromat', '303 Klean St, Zamboanga City', 0, 'Pictures/allklean.png', '0.5 km', '24 Hours', 'Deep-Clean Focus,Bedding & Large Items,Stain Pre-Treat,Sanitized Machines,Volume Discounts'),
("D'Laundry Station", '400 Station Rd, Manila', 0, 'Pictures/dlaundry.png', '3.0 km', '2 Days', 'Competitive Pricing,Large Loads Welcome,Hypoallergenic Options,Consistent Folding Standard,Rewash Guarantee'),
('RouTine Laundromat Roxas', '500 Roxas Blvd, Manila', 0, 'Pictures/routine.png', '2.2 km', '1-2 Days', 'Host-Ready Linens,Set Bundling,Turnover-Ready Packaging,Consistent Folding Standard,Volume Discounts');

-- 3. INSERT DUMMY CUSTOMERS FOR REVIEWS
-- (Customers 1001-1025)
INSERT INTO customer (custUsername, custPassword, custPhone, custAddress, custEmail)
VALUES
('maria_s', 'pass', '09000000001', 'N/A', 'maria@email.com'),
('kevin_l', 'pass', '09000000002', 'N/A', 'kevin@email.com'),
('priya_n', 'pass', '09000000003', 'N/A', 'priya@email.com'),
('daniel_c', 'pass', '09000000004', 'N/A', 'daniel@email.com'),
('hannah_r', 'pass', '09000000005', 'N/A', 'hannah@email.com'),
('alyssa_p', 'pass', '09000000006', 'N/A', 'alyssa@email.com'),
('mark_t', 'pass', '09000000007', 'N/A', 'mark@email.com'),
('jen_k', 'pass', '09000000008', 'N/A', 'jen@email.com'),
('ruben_v', 'pass', '09000000009', 'N/A', 'ruben@email.com'),
('sam_d', 'pass', '09000000010', 'N/A', 'sam@email.com'),
('nina_g', 'pass', '09000000011', 'N/A', 'nina@email.com'),
('owen_r', 'pass', '09000000012', 'N/A', 'owen@email.com'),
('lara_m', 'pass', '09000000013', 'N/A', 'lara@email.com'),
('jae_h', 'pass', '09000000014', 'N/A', 'jae@email.com'),
('victor_a', 'pass', '09000000015', 'N/A', 'victor@email.com'),
('celine_w', 'pass', '09000000016', 'N/A', 'celine@email.com'),
('arman_f', 'pass', '09000000017', 'N/A', 'arman@email.com'),
('patrice_q', 'pass', '09000000018', 'N/A', 'patrice@email.com'),
('ivy_z', 'pass', '09000000019', 'N/A', 'ivy@email.com'),
('diego_j', 'pass', '09000000020', 'N/A', 'diego@email.com'),
('mika_e', 'pass', '09000000021', 'N/A', 'mika@email.com'),
('harvey_b', 'pass', '09000000022', 'N/A', 'harvey@email.com'),
('kayla_s', 'pass', '09000000023', 'N/A', 'kayla@email.com'),
('noah_p', 'pass', '09000000024', 'N/A', 'noah@email.com'),
('trixie_l', 'pass', '09000000025', 'N/A', 'trixie@email.com');

-- 4. INSERT DUMMY ORDERS FOR REVIEWS
-- (Orders 2001-2025)
INSERT INTO orders (custID, laundromatID, orderStatus, totalAmount)
VALUES
-- WashEat (Laundromat 1, Customers 1001-1005)
(1001, 1, 'completed', 150.00), (1001, 1, 'completed', 150.00), (1001, 1, 'in_progress', 150.00), (1002, 1, 'completed', 200.00), (1003, 1, 'completed', 100.00), (1004, 1, 'completed', 50.00), (1005, 1, 'completed', 300.00),
-- La Vahh (Laundromat 2, Customers 1006-1010)
(1006, 2, 'completed', 150.00), (1007, 2, 'completed', 200.00), (1008, 2, 'completed', 100.00), (1009, 2, 'completed', 50.00), (1010, 2, 'completed', 300.00),
-- Allklean (Laundromat 3, Customers 1011-1015)
(1011, 3, 'completed', 150.00), (1012, 3, 'completed', 200.00), (1013, 3, 'completed', 100.00), (1014, 3, 'completed', 50.00), (1015, 3, 'completed', 300.00),
-- D'Laundry (Laundromat 4, Customers 1016-1020)
(1016, 4, 'completed', 150.00), (1017, 4, 'completed', 200.00), (1018, 4, 'completed', 100.00), (1019, 4, 'completed', 50.00), (1020, 4, 'completed', 300.00),
-- RouTine (Laundromat 5, Customers 1021-1025)
(1021, 5, 'completed', 150.00), (1022, 5, 'completed', 200.00), (1023, 5, 'completed', 100.00), (1024, 5, 'completed', 50.00), (1025, 5, 'completed', 300.00);

-- 5. INSERT SERVICES
INSERT INTO service (laundromatID, serviceName, description, price, estimatedTime)
VALUES
(1, 'Wash & Fold', 'Standard wash, dry, and fold service.', 65.00, 24), -- WashEat
(1, 'Dry Clean', 'Special care for delicate items.', 250.00, 48),     -- WashEat
(2, 'Press Only', 'Professional ironing service.', 50.00, 3),        -- La Vahh
(2, 'Bulky Items', 'For comforters, blankets, and large items.', 300.00, 48), -- La Vahh
(3, 'Sneakers', 'Deep clean for your shoes.', 200.00, 72),           -- Allklean
(3, 'Pet Items', 'Wash & dry for pet beds and blankets.', 150.00, 24), -- Allklean
(4, 'Wash & Fold', 'Standard wash, dry, and fold service.', 70.00, 24), -- D'Laundry
(5, 'Dry Clean', 'Special care for delicate items.', 260.00, 48);      -- RouTine

-- 6. INSERT REVIEWS
-- (Linked to orders 2001-2025)

-- WashEat Laundry (Laundromat 1)
INSERT INTO review (orderID, laundromatID, custID, rating, comment) VALUES
(2001, 1, 1001, 5, 'Dropped off at midnight and still got a next-day turnaround. Clothes were neatly folded and smelled fresh.'),
(2003, 1, 1003, 5, 'Hypoallergenic option really helped. No irritation at all, and towels are super soft.'),
(2004, 1, 1004, 4, 'Machines looked sanitized and the staff was responsive on pickup time.'),
(2005, 1, 1005, 5, 'Comforters came back fluffy and sealed. Very happy with the packaging.');

-- La Vahh Laundromat (Laundromat 2)
INSERT INTO review (orderID, laundromatID, custID, rating, comment) VALUES
(2006, 2, 1006, 5, 'They handled delicates perfectly. No shrinking, no color bleed. Will return.'),
(2007, 2, 1007, 5, 'Smells great, folded consistently, and finished earlier than quoted.'),
(2008, 2, 1008, 5, 'Requested hand-finished for a blouse. Looked crisp without harsh creases.'),
(2009, 2, 1009, 4, 'Staff messaged when it was ready. Smooth experience from drop-off to pickup.'),
(2010, 2, 1010, 4, 'Good value for the care they put into each item.');

-- Allklean Laundromat (Laundromat 3)
INSERT INTO review (orderID, laundromatID, custID, rating, comment) VALUES
(2011, 3, 1011, 5, 'Deep cleaned our duvet and it looks new again. They handled bulk items well.'),
(2012, 3, 1012, 5, 'Pre-treated a sauce stain on jeans. Totally gone.'),
(2013, 3, 1013, 4, 'Machines look sanitized and the folding was tidy. Reliable spot.'),
(2014, 3, 1014, 4, 'Gave us a small discount for multiple bags. Appreciate the transparency.'),
(2015, 3, 1015, 5, 'Sturdy packaging with clear labels. Easy to put everything away.');

-- D'Laundry Station (Laundromat 4)
INSERT INTO review (orderID, laundromatID, custID, rating, comment) VALUES
(2016, 4, 1016, 5, 'Budget friendly without cutting corners. Fold lines are consistent.'),
(2017, 4, 1017, 4, 'Handled our big weekâ€™s load just fine. Nothing missing, nothing mixed up.'),
(2018, 4, 1018, 5, 'Requested a rewash on a stubborn stain and they honored it, no fuss.'),
(2019, 4, 1019, 4, 'Quick counter service and helpful with sorting instructions.'),
(2020, 4, 1020, 4, 'Good for routine washes. Turnaround matched the estimate.');

-- RouTine Laundromat Roxas (Laundromat 5)
INSERT INTO review (orderID, laundromatID, custID, rating, comment) VALUES
(2021, 5, 1021, 5, 'Linens came back host-ready, folded in sets with size labels. Perfect for our Airbnb.'),
(2022, 5, 1022, 5, 'Bundled towels per bathroom as requested. Huge time-saver on turnover.'),
(2023, 5, 1023, 5, 'Packaging kept sheets dust-free while stored. Looks professional.'),
(2024, 5, 1024, 5, 'Consistent folding means quick shelf stocking. Appreciate the details.'),
(2025, 5, 1025, 4, 'Reliable pickup and drop-off windows. Makes scheduling easier.');


-- ------------------------------------------------------------------
-- 4. FINAL RATING CALCULATION
-- ------------------------------------------------------------------
-- This query calculates the average rating from the 'review' table
-- and updates the 'rating' column in the 'laundromat' table.

-- Temporarily disable safe update mode for this one query
SET SQL_SAFE_UPDATES = 0;

UPDATE laundromat l
JOIN (
    SELECT laundromatID, AVG(rating) AS avg_rating
    FROM review
    GROUP BY laundromatID
) r ON l.laundromatID = r.laundromatID
SET l.rating = r.avg_rating;

-- Re-enable safe update mode
SET SQL_SAFE_UPDATES = 1;