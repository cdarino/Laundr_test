-- Merged Laundr database schema + seed data (demo user removed)
-- Drop and create the laundr database from scratch
DROP DATABASE IF EXISTS laundr;
CREATE DATABASE laundr CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE laundr;

-- ------------------------------------------------------------------
-- TABLES
-- ------------------------------------------------------------------

-- Admins
CREATE TABLE admin (
  adminID INT AUTO_INCREMENT PRIMARY KEY,
  adminUsername VARCHAR(100) NOT NULL,
  adminPassword VARCHAR(255) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Customers
-- Start custID at 1001 to match sample data
CREATE TABLE customer (
  custID INT AUTO_INCREMENT PRIMARY KEY,
  custUsername VARCHAR(100) NOT NULL UNIQUE,
  custPassword VARCHAR(255) NOT NULL,
  custPhone VARCHAR(30) UNIQUE,
  custAddress VARCHAR(255),
  custEmail VARCHAR(255) UNIQUE,
  walletBalance DECIMAL(10,2) DEFAULT 0.00
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 AUTO_INCREMENT=1001;

-- Laundromats
CREATE TABLE laundromat (
  laundromatID INT AUTO_INCREMENT PRIMARY KEY,
  laundromatName VARCHAR(150) NOT NULL,
  laundromatAddress VARCHAR(255) NOT NULL,
  rating DECIMAL(3,2) DEFAULT 0.00,
  imagePath VARCHAR(255) DEFAULT 'Pictures/default.png',
  distanceFromUser VARCHAR(50) DEFAULT 'N/A',
  estimatedTime VARCHAR(50) DEFAULT 'N/A',
  highlights TEXT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Services offered by laundromats
CREATE TABLE service (
  serviceID INT AUTO_INCREMENT PRIMARY KEY,
  laundromatID INT NOT NULL,
  serviceName VARCHAR(100),
  description TEXT,
  basePrice DECIMAL(10,2),
  estimatedTime INT, -- in hours
  iconPath VARCHAR(255),
  CONSTRAINT fk_service_laundromat FOREIGN KEY (laundromatID) REFERENCES laundromat(laundromatID) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Orders
CREATE TABLE orders (
  orderID INT AUTO_INCREMENT PRIMARY KEY,
  custID INT NOT NULL,
  laundromatID INT NOT NULL,
  orderDate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  pickupAddress VARCHAR(150),
  deliveryAddress VARCHAR(150),
  orderStatus ENUM('pending','accepted','in_progress','ready_for_delivery','out_for_delivery','completed') NOT NULL DEFAULT 'pending',
  totalAmount DECIMAL(10,2) NOT NULL DEFAULT 0.00,
  instructions TEXT,
  paymentMethod VARCHAR(100),
  CONSTRAINT fk_orders_customer FOREIGN KEY (custID) REFERENCES customer(custID) ON DELETE RESTRICT ON UPDATE CASCADE,
  CONSTRAINT fk_orders_laundromat FOREIGN KEY (laundromatID) REFERENCES laundromat(laundromatID) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 AUTO_INCREMENT=2001;

-- Order details linking orders to services
CREATE TABLE orderDetails (
  orderDetailsID INT AUTO_INCREMENT PRIMARY KEY,
  orderID INT NOT NULL,
  serviceID INT NOT NULL,
  quantity INT DEFAULT 1,
  subtotal DECIMAL(10,2),
  CONSTRAINT fk_orderdetails_order FOREIGN KEY (orderID) REFERENCES orders(orderID) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT fk_orderdetails_service FOREIGN KEY (serviceID) REFERENCES service(serviceID) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Payments
CREATE TABLE payment (
  paymentID INT AUTO_INCREMENT PRIMARY KEY,
  orderID INT NOT NULL,
  paymentDate DATETIME DEFAULT CURRENT_TIMESTAMP,
  paymentMethod ENUM('cash','card','gcash','maya') DEFAULT 'cash',
  paymentStatus ENUM('unpaid','paid','refunded') DEFAULT 'unpaid',
  amount DECIMAL(10,2),
  CONSTRAINT fk_payment_order FOREIGN KEY (orderID) REFERENCES orders(orderID) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Reviews
CREATE TABLE review (
  reviewID INT AUTO_INCREMENT PRIMARY KEY,
  orderID INT,
  laundromatID INT,
  custID INT,
  rating INT CHECK (rating BETWEEN 1 AND 5),
  comment TEXT,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_review_order FOREIGN KEY (orderID) REFERENCES orders(orderID) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT fk_review_laundromat FOREIGN KEY (laundromatID) REFERENCES laundromat(laundromatID) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT fk_review_customer FOREIGN KEY (custID) REFERENCES customer(custID) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Notifications (user-facing notifications)
CREATE TABLE notification (
  notificationID INT AUTO_INCREMENT PRIMARY KEY,
  custID INT NOT NULL,
  message TEXT NOT NULL,
  isRead TINYINT(1) NOT NULL DEFAULT 0,
  createdAt DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_notifications_customer FOREIGN KEY (custID) REFERENCES customer(custID) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- ------------------------------------------------------------------
-- SEED DATA
-- ------------------------------------------------------------------

-- Admins (keep both admin accounts from both scripts)
INSERT INTO admin (adminUsername, adminPassword) VALUES
('admin', 'admin'),
('laundradmin', 'laundradmin');

-- Laundromats (combined set from both inputs; duplicates preserved only if addresses differ)
INSERT INTO laundromat (laundromatName, laundromatAddress, rating, imagePath, distanceFromUser, estimatedTime, highlights) VALUES
('WashEat Laundry', '456 Mabini Ave., Sample City', 4.70, 'Pictures/default.png', '1.2 km', '24-36 hrs', 'Open 24 Hours;Hypoallergenic Options;Stain Pre-Treat;Sanitized Machines;Bedding & Large Items;Competitive Pricing'),
('WashEat Laundry', '100 Wash St, Zamboanga City', 0.00, 'Pictures/washeat.png', '1.0 km', '1 Day', 'Open 24 Hours,Hypoallergenic Options,Stain Pre-Treat,Sanitized Machines,Bedding & Large Items,Competitive Pricing'),
('La Vahh Laundromat', '200 La Vahh Ave, Cebu City', 0.00, 'Pictures/lavahh.png', '2.1 km', '1-2 Days', 'Extended Hours,Delicates Care,Hypoallergenic Options,Hand-Finished Option,Rewash Guarantee'),
('Allklean Laundromat', '303 Klean St, Zamboanga City', 0.00, 'Pictures/allklean.png', '0.5 km', '24 Hours', 'Deep-Clean Focus,Bedding & Large Items,Stain Pre-Treat,Sanitized Machines,Volume Discounts'),
('D''Laundry Station', '400 Station Rd, Manila', 0.00, 'Pictures/dlaundry.png', '3.0 km', '2 Days', 'Competitive Pricing,Large Loads Welcome,Hypoallergenic Options,Consistent Folding Standard,Rewash Guarantee'),
('RouTine Laundromat Roxas', '500 Roxas Blvd, Manila', 0.00, 'Pictures/routine.png', '2.2 km', '1-2 Days', 'Host-Ready Linens,Set Bundling,Turnover-Ready Packaging,Consistent Folding Standard,Volume Discounts');

-- Dummy customers (1001-1025) -- NOTE: the original 'demo' user from the first script is intentionally NOT inserted.
INSERT INTO customer (custUsername, custPassword, custPhone, custAddress, custEmail) VALUES
('maria_s', 'pass', '09000000001', 'N/A', 'maria@email.com'),
('kevin_l', 'pass', '09000000002', 'N/A', 'kevin@email.com'),
('priya_n', 'pass', '09000000003', 'N/A', 'priya@email.com'),
('daniel_c', 'pass', '09000000004', 'N/A', 'daniel@email.com'),
('hannah_r', 'pass', '09000000005', 'N/A', 'hannah@email.com'),
('alyssa_p', 'pass', '09000000006', 'N/A', 'alyssa@email.com'),
('mark_t', 'pass', '09000000007', 'N/A', 'mark@email.com'),
('jen_k', 'pass', '09000000008', 'N/A', 'jen@email.com'),
('ruben_v', 'pass', '09000000009', 'N/A', 'ruben@email.com'),
('sam_d', 'pass', '09000000010', 'N/A', 'sam@email.com'),
('nina_g', 'pass', '09000000011', 'N/A', 'nina@email.com'),
('owen_r', 'pass', '09000000012', 'N/A', 'owen@email.com'),
('lara_m', 'pass', '09000000013', 'N/A', 'lara@email.com'),
('jae_h', 'pass', '09000000014', 'N/A', 'jae@email.com'),
('victor_a', 'pass', '09000000015', 'N/A', 'victor@email.com'),
('celine_w', 'pass', '09000000016', 'N/A', 'celine@email.com'),
('arman_f', 'pass', '09000000017', 'N/A', 'arman@email.com'),
('patrice_q', 'pass', '09000000018', 'N/A', 'patrice@email.com'),
('ivy_z', 'pass', '09000000019', 'N/A', 'ivy@email.com'),
('diego_j', 'pass', '09000000020', 'N/A', 'diego@email.com'),
('mika_e', 'pass', '09000000021', 'N/A', 'mika@email.com'),
('harvey_b', 'pass', '09000000022', 'N/A', 'harvey@email.com'),
('kayla_s', 'pass', '09000000023', 'N/A', 'kayla@email.com'),
('noah_p', 'pass', '09000000024', 'N/A', 'noah@email.com'),
('trixie_l', 'pass', '09000000025', 'N/A', 'trixie@email.com');

-- Orders (2001-2025) per the second script's sample data
INSERT INTO orders (custID, laundromatID, orderStatus, totalAmount) VALUES
-- WashEat (Laundromat 1, Customers 1001-1005)
(1001, 1, 'completed', 150.00),
(1001, 1, 'completed', 150.00),
(1001, 1, 'in_progress', 150.00),
(1002, 1, 'completed', 200.00),
(1003, 1, 'completed', 100.00),
(1004, 1, 'completed', 50.00),
(1005, 1, 'completed', 300.00),
-- La Vahh (Laundromat 3 in this merged order set -- note laundromatIDs may vary depending on insertion order)
(1006, 3, 'completed', 150.00),
(1007, 3, 'completed', 200.00),
(1008, 3, 'completed', 100.00),
(1009, 3, 'completed', 50.00),
(1010, 3, 'completed', 300.00),
-- Allklean (Laundromat 4)
(1011, 4, 'completed', 150.00),
(1012, 4, 'completed', 200.00),
(1013, 4, 'completed', 100.00),
(1014, 4, 'completed', 50.00),
(1015, 4, 'completed', 300.00),
-- D'Laundry (Laundromat 5)
(1016, 5, 'completed', 150.00),
(1017, 5, 'completed', 200.00),
(1018, 5, 'completed', 100.00),
(1019, 5, 'completed', 50.00),
(1020, 5, 'completed', 300.00),
-- RouTine (Laundromat 6)
(1021, 6, 'completed', 150.00),
(1022, 6, 'completed', 200.00),
(1023, 6, 'completed', 100.00),
(1024, 6, 'completed', 50.00),
(1025, 6, 'completed', 300.00);

-- Services (sample)
INSERT INTO service (laundromatID, serviceName, description, basePrice, estimatedTime, iconPath) VALUES
(1, 'Wash & Fold', 'Standard wash, dry, and fold service.', 65.00, 24, 'Icons/Services/washandFold.svg'),
(1, 'Dry Clean', 'Special care for delicate items.', 250.00, 48, 'Icons/Services/dryClean.svg'),
(2, 'Press Only', 'Professional ironing service.', 50.00, 3, 'Icons/Services/pressOnly.svg'),
(2, 'Bulky Items', 'For comforters, blankets, and large items.', 300.00, 48, 'Icons/Services/bulkyItems.svg'),
(3, 'Sneakers', 'Deep clean for your shoes.', 200.00, 72, 'Icons/Services/sneakers.svg'),
(3, 'Pet Items', 'Wash & dry for pet beds and blankets.', 150.00, 24, 'Icons/Services/laundry.svg');

-- Reviews (linked to orders 2001-2025)
-- Note: The orderIDs are the auto-incremented values from the orders insertion above (2001..).
-- Inserted in the same order/quantity as the second script to preserve the sample dataset.
INSERT INTO review (orderID, laundromatID, custID, rating, comment) VALUES
(2001, 1, 1001, 5, 'Dropped off at midnight and still got a next-day turnaround. Clothes were neatly folded and smelled fresh.'),
(2003, 1, 1003, 5, 'Hypoallergenic option really helped. No irritation at all, and towels are super soft.'),
(2004, 1, 1004, 4, 'Machines looked sanitized and the staff was responsive on pickup time.'),
(2005, 1, 1005, 5, 'Comforters came back fluffy and sealed. Very happy with the packaging.'),
(2006, 3, 1006, 5, 'They handled delicates perfectly. No shrinking, no color bleed. Will return.'),
(2007, 3, 1007, 5, 'Smells great, folded consistently, and finished earlier than quoted.'),
(2008, 3, 1008, 5, 'Requested hand-finished for a blouse. Looked crisp without harsh creases.'),
(2009, 3, 1009, 4, 'Staff messaged when it was ready. Smooth experience from drop-off to pickup.'),
(2010, 3, 1010, 4, 'Good value for the care they put into each item.'),
(2011, 4, 1011, 5, 'Deep cleaned our duvet and it looks new again. They handled bulk items well.'),
(2012, 4, 1012, 5, 'Pre-treated a sauce stain on jeans. Totally gone.'),
(2013, 4, 1013, 4, 'Machines look sanitized and the folding was tidy. Reliable spot.'),
(2014, 4, 1014, 4, 'Gave us a small discount for multiple bags. Appreciate the transparency.'),
(2015, 4, 1015, 5, 'Sturdy packaging with clear labels. Easy to put everything away.'),
(2016, 5, 1016, 5, 'Budget friendly without cutting corners. Fold lines are consistent.'),
(2017, 5, 1017, 4, 'Handled our big weekâ€™s load just fine. Nothing missing, nothing mixed up.'),
(2018, 5, 1018, 5, 'Requested a rewash on a stubborn stain and they honored it, no fuss.'),
(2019, 5, 1019, 4, 'Quick counter service and helpful with sorting instructions.'),
(2020, 5, 1020, 4, 'Good for routine washes. Turnaround matched the estimate.'),
(2021, 6, 1021, 5, 'Linens came back host-ready, folded in sets with size labels. Perfect for our Airbnb.'),
(2022, 6, 1022, 5, 'Bundled towels per bathroom as requested. Huge time-saver on turnover.'),
(2023, 6, 1023, 5, 'Packaging kept sheets dust-free while stored. Looks professional.'),
(2024, 6, 1024, 5, 'Consistent folding means quick shelf stocking. Appreciate the details.'),
(2025, 6, 1025, 4, 'Reliable pickup and drop-off windows. Makes scheduling easier.');

-- (Optional) Insert a few sample notifications (not required but useful for testing)
INSERT INTO notification (custID, message) VALUES
(1001, 'Your order #2001 is ready for pickup.'),
(1002, 'Thanks for your recent order!');

-- ------------------------------------------------------------------
-- FINAL RATING CALCULATION
-- ------------------------------------------------------------------
-- Temporarily disable safe update mode for the update
SET SQL_SAFE_UPDATES = 0;

UPDATE laundromat l
JOIN (
  SELECT laundromatID, AVG(rating) AS avg_rating
  FROM review
  GROUP BY laundromatID
) r ON l.laundromatID = r.laundromatID
SET l.rating = r.avg_rating;

SET SQL_SAFE_UPDATES = 1;

-- End of merged migration (demo user intentionally removed)
